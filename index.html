<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>God Sim: Roguelite</title>
    <style>
        :root {
            --bg: #050510;
            --panel: #151525;
            --accent: #00d2d3;
            --danger: #ff4757;
            --rare: #a55eea; /* Isotope Color */
            --gold: #f1c40f;
            --text: #fff;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            transition: opacity 0.5s;
            z-index: 10;
        }
        
        .hidden { display: none !important; }

        /* --- MAIN MENU --- */
        h1 { font-size: 4rem; margin-bottom: 0; text-shadow: 0 0 20px var(--accent); }
        .subtitle { color: var(--rare); font-size: 1.2rem; margin-bottom: 40px; }
        
        .menu-btn {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 15px 40px;
            font-size: 1.5rem;
            margin: 10px;
            cursor: pointer;
            transition: 0.2s;
            width: 300px;
            text-transform: uppercase;
            font-weight: bold;
        }
        .menu-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent); }
        
        .save-info { position: absolute; bottom: 20px; right: 20px; color: #555; }

        /* --- UPGRADE MENU --- */
        #upgrade-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .upgrade-card {
            background: var(--panel);
            border: 1px solid #333;
            padding: 20px;
            width: 200px;
            cursor: pointer;
            text-align: left;
        }
        .upgrade-card:hover { border-color: var(--rare); }
        .upgrade-card.owned { border-color: var(--gold); opacity: 0.6; }
        
        /* --- GAME HUD --- */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; gap: 40px;
            padding: 15px 0;
            border-bottom: 2px solid var(--accent);
            z-index: 5;
        }
        .stat-box { text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: bold; }
        .stat-lbl { font-size: 0.8rem; opacity: 0.7; }
        
        #rival-meter { color: var(--danger); }
        #isotope-meter { color: var(--rare); }

        /* --- ISOMETRIC WORLD --- */
        #game-view {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            perspective: 800px;
        }
        
        #iso-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            transform: rotateX(60deg) rotateZ(-45deg);
            transform-style: preserve-3d;
            gap: 4px;
        }

        .tile {
            width: 50px; height: 50px;
            background: #2d3436;
            position: relative;
            transform-style: preserve-3d;
            transition: 0.3s;
        }
        
        .tile.player { background: #00cec9; box-shadow: 0 0 10px #00cec9; }
        .tile.rival { background: #d63031; box-shadow: 0 0 15px #d63031; animation: pulse 1s infinite; }
        
        /* Buildings */
        .block {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 10px;
            background: inherit;
            transform: rotateX(-90deg) translateZ(0);
            transform-origin: bottom;
            transition: height 0.5s;
            border: 1px solid rgba(255,255,255,0.2);
        }

        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        /* --- EVENT MODAL --- */
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none; align-items: center; justify-content: center; z-index: 100;
        }
        #modal { background: var(--panel); padding: 40px; border: 2px solid var(--accent); max-width: 500px; text-align: center; }
        .btn-row { display: flex; gap: 20px; margin-top: 20px; }
        .choice-btn { flex: 1; padding: 15px; background: #333; color: white; border: none; cursor: pointer; }
        .choice-btn:hover { background: var(--accent); color: black; }

        /* --- ACHIEVEMENTS --- */
        #achievements-panel {
            position: absolute; top: 10px; right: 10px;
            text-align: right; pointer-events: none;
        }
        .ach-badge {
            background: var(--gold); color: black;
            padding: 5px 10px; margin-bottom: 5px;
            font-weight: bold; font-size: 0.8rem;
            border-radius: 4px; opacity: 0;
            animation: slideIn 0.5s forwards;
        }
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    </style>
</head>
<body>

    <div id="menu-screen" class="screen">
        <h1>GOD SIM</h1>
        <div class="subtitle">PLANETARY EVOLUTION</div>
        <div style="font-size: 1.5rem; margin-bottom: 20px;">
            ISOTOPES: <span style="color:var(--rare)" id="meta-currency">0</span>
        </div>
        <button class="menu-btn" onclick="startGame()">NEW GALAXY</button>
        <button class="menu-btn" onclick="showUpgrades()">CORE UPGRADES</button>
        <div class="save-info">Auto-save enabled</div>
    </div>

    <div id="upgrade-screen" class="screen hidden">
        <h2>PLANETARY CORE</h2>
        <div id="upgrade-grid">
            </div>
        <button class="menu-btn" onclick="showMenu()">BACK</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="hud">
            <div class="stat-box"><div class="stat-val" id="ui-year">0/100</div><div class="stat-lbl">YEAR</div></div>
            <div class="stat-box"><div class="stat-val" id="ui-pop">0</div><div class="stat-lbl">POPULATION</div></div>
            <div class="stat-box"><div class="stat-val" id="ui-faith">0</div><div class="stat-lbl">FAITH</div></div>
            <div class="stat-box"><div class="stat-val" id="rival-meter">SAFE</div><div class="stat-lbl">THREAT</div></div>
        </div>

        <div id="achievements-panel"></div>

        <div id="game-view">
            <div id="iso-grid"></div>
        </div>

        <button style="position: absolute; bottom: 30px; padding: 15px 30px; background: var(--danger); color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 5px;" onclick="smiteRivals()">
            SMITE RIVALS (50 FAITH)
        </button>
    </div>

    <div id="modal-overlay">
        <div id="modal">
            <h2 id="ev-title">Event</h2>
            <p id="ev-text">...</p>
            <div class="btn-row">
                <button class="choice-btn" id="btn-a">Option A</button>
                <button class="choice-btn" id="btn-b">Option B</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { events } from './events.js';

        // --- SAVE DATA (META PROGRESSION) ---
        let saveData = JSON.parse(localStorage.getItem('godSimSave')) || {
            isotopes: 0,
            upgrades: [],
            achievements: []
        };

        // --- UPGRADES DATABASE ---
        const upgrades = [
            { id: 'start_pop', name: 'Genetic Seeds', cost: 5, desc: 'Start with +10 Pop', effect: (s) => s.pop += 10 },
            { id: 'faith_boost', name: 'Divine Wind', cost: 10, desc: '+1 Faith per Tick', effect: (s) => s.faithGen += 1 },
            { id: 'rival_slow', name: 'Holy Fire', cost: 20, desc: 'Rivals spread slower', effect: (s) => s.rivalRate *= 0.5 },
            { id: 'time_ext', name: 'Time Dilation', cost: 50, desc: 'Max Year +50', effect: (s) => s.maxYear += 50 }
        ];

        // --- GAME SESSION STATE ---
        let state = {
            active: false, paused: false,
            year: 0, maxYear: 100,
            pop: 2, faith: 0, 
            rivals: 0, rivalRate: 0.05, faithGen: 0,
            grid: [] // 0=Empty, 1=Player, 2=Rival
        };

        // --- SYSTEM: INITIALIZATION ---
        window.showMenu = () => {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('menu-screen').classList.remove('hidden');
            document.getElementById('meta-currency').innerText = saveData.isotopes;
        };

        window.showUpgrades = () => {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('upgrade-screen').classList.remove('hidden');
            renderUpgrades();
        };

        window.startGame = () => {
            // Reset Session
            state = { 
                active: true, paused: false,
                year: 0, maxYear: 100,
                pop: 2, faith: 50, 
                rivals: 0, rivalRate: 0.05, faithGen: 0,
                grid: Array(36).fill(0) 
            };
            
            // Apply Meta Upgrades
            upgrades.forEach(u => {
                if(saveData.upgrades.includes(u.id)) u.effect(state);
            });

            // Random initial placement
            state.grid[14] = 1; 

            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('game-screen').classList.remove('hidden');
            
            renderGrid();
        };

        // --- SYSTEM: GAME LOOP ---
        setInterval(() => {
            if(!state.active || state.paused) return;

            state.year++;
            
            // Resources
            state.faith += Math.floor(state.pop / 5) + state.faithGen;
            
            // Player Expansion
            if(state.faith > 20 && Math.random() > 0.6) {
                expandTerritory(1); // 1 = Player
            }

            // Rival Expansion (The Threat)
            if(Math.random() < state.rivalRate + (state.year * 0.002)) {
                spawnRival();
            }

            // Check Achievements
            checkAchievements();

            // End Condition
            if(state.year >= state.maxYear) endGame(true);
            if(state.pop <= 0) endGame(false);

            // Events
            if(Math.random() < 0.1) triggerEvent();

            updateHUD();
            renderGrid();

        }, 500); // Fast ticks (0.5s per year)

        // --- LOGIC ---
        function expandTerritory(type) {
            let emptyIndices = state.grid.map((v, i) => v === 0 ? i : -1).filter(i => i !== -1);
            if(emptyIndices.length > 0) {
                let idx = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
                state.grid[idx] = type;
                if(type === 1) state.pop += 5;
                if(type === 2) {
                    state.pop -= 2; // Rivals kill pop
                    state.rivals++;
                }
            }
        }

        function spawnRival() {
            expandTerritory(2);
        }

        window.smiteRivals = () => {
            if(state.faith >= 50) {
                state.faith -= 50;
                // Remove random rival tiles
                state.grid = state.grid.map(t => (t === 2 && Math.random() > 0.3) ? 0 : t);
                renderGrid();
            }
        };

        function endGame(survived) {
            state.active = false;
            let earned = Math.floor(state.pop / 10) + Math.floor(state.faith / 100);
            if(survived) earned += 5; // Survival Bonus

            saveData.isotopes += earned;
            localStorage.setItem('godSimSave', JSON.stringify(saveData));

            alert(`SESSION ENDED\n\nIsotopes Earned: ${earned}`);
            window.showMenu();
        }

        function checkAchievements() {
            if(state.pop >= 100 && !saveData.achievements.includes('pop100')) {
                unlockAch('pop100', 'Legion (Reach 100 Pop)');
                saveData.isotopes += 10;
            }
            if(state.year >= 90 && state.rivals === 0 && !saveData.achievements.includes('clean')) {
                unlockAch('clean', 'Pure World (No Rivals at Year 90)');
                saveData.isotopes += 20;
            }
        }

        function unlockAch(id, txt) {
            saveData.achievements.push(id);
            localStorage.setItem('godSimSave', JSON.stringify(saveData));
            
            let div = document.createElement('div');
            div.className = 'ach-badge';
            div.innerText = "ðŸ† " + txt;
            document.getElementById('achievements-panel').appendChild(div);
        }

        // --- RENDERING ---
        function updateHUD() {
            document.getElementById('ui-year').innerText = `${state.year}/${state.maxYear}`;
            document.getElementById('ui-pop').innerText = state.pop;
            document.getElementById('ui-faith').innerText = state.faith;
            
            let threat = document.getElementById('rival-meter');
            let rivalCount = state.grid.filter(x => x === 2).length;
            if(rivalCount === 0) { threat.innerText = "SAFE"; threat.style.color = "lime"; }
            else if(rivalCount < 5) { threat.innerText = "WARNING"; threat.style.color = "yellow"; }
            else { threat.innerText = "CRITICAL"; threat.style.color = "red"; }
        }

        function renderGrid() {
            const gridEl = document.getElementById('iso-grid');
            gridEl.innerHTML = '';
            
            state.grid.forEach((type, i) => {
                let tile = document.createElement('div');
                tile.className = 'tile';
                
                if(type === 1) { // Player
                    tile.classList.add('player');
                    let height = Math.min(50, 10 + Math.floor(state.pop / 5));
                    let block = document.createElement('div');
                    block.className = 'block';
                    block.style.height = height + 'px';
                    tile.appendChild(block);
                }
                
                if(type === 2) { // Rival
                    tile.classList.add('rival');
                    let block = document.createElement('div');
                    block.className = 'block';
                    block.style.height = '20px'; // Spikes
                    block.style.background = 'var(--danger)';
                    tile.appendChild(block);
                }

                gridEl.appendChild(tile);
            });
        }

        function renderUpgrades() {
            const grid = document.getElementById('upgrade-grid');
            grid.innerHTML = '';
            upgrades.forEach(u => {
                let div = document.createElement('div');
                let owned = saveData.upgrades.includes(u.id);
                div.className = `upgrade-card ${owned ? 'owned' : ''}`;
                div.innerHTML = `
                    <div style="font-weight:bold; color:var(--accent)">${u.name}</div>
                    <div style="font-size:0.8rem; margin:5px 0">${u.desc}</div>
                    <div style="color:var(--gold)">${owned ? 'OWNED' : u.cost + ' Isotopes'}</div>
                `;
                if(!owned) {
                    div.onclick = () => buyUpgrade(u);
                }
                grid.appendChild(div);
            });
        }

        function buyUpgrade(u) {
            if(saveData.isotopes >= u.cost) {
                saveData.isotopes -= u.cost;
                saveData.upgrades.push(u.id);
                localStorage.setItem('godSimSave', JSON.stringify(saveData));
                document.getElementById('meta-currency').innerText = saveData.isotopes;
                renderUpgrades();
            } else {
                alert("Not enough Isotopes!");
            }
        }

        // --- EVENT SYSTEM ---
        function triggerEvent() {
            state.paused = true;
            const valid = events.filter(e => state.year >= e.reqYear);
            const ev = valid[Math.floor(Math.random() * valid.length)];
            
            document.getElementById('ev-title').innerText = "Anomaly Detected";
            document.getElementById('ev-text').innerText = ev.text;
            
            setupBtn('btn-a', ev.a);
            setupBtn('btn-b', ev.b);
            
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function setupBtn(id, choice) {
            let btn = document.getElementById(id);
            btn.innerText = choice.txt;
            btn.onclick = () => {
                if(choice.pop) state.pop += choice.pop;
                if(choice.faith) state.faith += choice.faith;
                if(choice.isotopes) {
                    saveData.isotopes += choice.isotopes;
                    localStorage.setItem('godSimSave', JSON.stringify(saveData));
                    alert("Isotope collected!");
                }
                document.getElementById('modal-overlay').style.display = 'none';
                state.paused = false;
            };
        }

        // Init
        window.showMenu();

    </script>
</body>
        </html>
