<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>God Core: Evolution + Addons</title>
    <style>
        :root {
            --bg: #020205; --panel: rgba(10, 10, 15, 0.9); --accent: #00d2d3;
            --rare: #a55eea; --gold: #f1c40f; --danger: #ff4757; --text: #e0e0e0;
        }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; height: 100vh; overflow: hidden; display: flex;
        }

        /* --- ADDON STORE STYLING --- */
        .addon-section { margin-top: 30px; border-top: 1px solid #222; padding-top: 20px; }
        .addon-card {
            background: linear-gradient(45deg, #111, #050505);
            border: 1px solid #333; padding: 10px; border-radius: 8px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .addon-locked { opacity: 0.5; filter: grayscale(1); }

        /* --- STABILIZATION MINIGAME --- */
        #stabilize-ui {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            z-index: 200; background: var(--danger); color: white; padding: 20px;
            border-radius: 10px; text-align: center; box-shadow: 0 0 30px var(--danger);
            animation: shake 0.2s infinite;
        }
        @keyframes shake { 0%{left:50.5%} 50%{left:49.5%} 100%{left:50%} }

        /* --- GRID & TILES --- */
        .screen { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        .menu-container { display: flex; gap: 40px; width: 95%; max-width: 1200px; height: 85vh; }
        .skill-tree { flex: 2; background: var(--panel); padding: 30px; border-radius: 20px; overflow-y: auto; border: 1px solid #222; }
        
        #grid-container { display: grid; grid-template-columns: repeat(3, 140px); transform: rotateX(50deg) rotateZ(-45deg); transform-style: preserve-3d; gap: 15px; }
        .tile { width: 140px; height: 140px; border-radius: 8px; background-color: #0d0d12; transition: 0.4s; }
        .tile.player { background-image: url('https://images.unsplash.com/photo-1449156003053-96462a6d3fe0?auto=format&fit=crop&w=200'); box-shadow: 0 0 15px var(--accent); }
        .tile.rival { background-image: url('https://images.unsplash.com/photo-1536431311719-398b6704d40f?auto=format&fit=crop&w=200'); filter: hue-rotate(-70deg); }
        .tile.empty { opacity: 0.1; background-image: url('https://images.unsplash.com/photo-1500382017468-9049fee74a62?auto=format&fit=crop&w=200'); }

        #sidebar { width: 350px; background: var(--panel); border-left: 1px solid #222; padding: 25px; display: flex; flex-direction: column; }
        .buy-btn { background: var(--accent); color: #000; border: none; padding: 10px; font-weight: 800; cursor: pointer; border-radius: 5px; }
        .buy-btn:disabled { background: #222; color: #555; }
    </style>
</head>
<body>

    <div id="menu-screen" class="screen">
        <div class="menu-container">
            <div style="flex:0.8;">
                <h1 style="font-size: 3rem;">GOD<span style="color:var(--accent)">CORE</span></h1>
                <div style="font-size: 2rem; color: var(--rare);" id="meta-isotopes">0 ⚛</div>
                <button class="buy-btn" style="width:100%; padding:20px; margin-top:20px;" onclick="window.startGame()">START CYCLE</button>
                
                <div class="addon-section">
                    <div class="category-title">Addon Marketplace</div>
                    <div id="addon-list"></div>
                </div>
            </div>
            <div class="skill-tree">
                <div id="tree-survival"></div>
                <div id="tree-expansion"></div>
                <div id="tree-celestial"></div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="stabilize-ui" class="hidden">
            <h3>CORE INSTABILITY!</h3>
            <button class="buy-btn" style="background:white;" onclick="window.stabilize()">CLICK TO STABILIZE</button>
            <div id="stab-timer" style="margin-top:10px;">3.0s</div>
        </div>

        <div id="game-view" style="flex:1; display:flex; align-items:center; justify-content:center;">
            <div id="grid-container"></div>
        </div>

        <div id="sidebar">
            <div id="ui-year" style="font-size:2rem; font-weight:900;">30Y</div>
            <div id="ui-pop">Pop: 10</div>
            <div id="event-log" style="flex:1; margin-top:20px; font-size:0.8rem;"></div>
            <button class="buy-btn" style="background:var(--danger); color:white;" onclick="window.smite()">SMITE (50 Faith)</button>
        </div>
    </div>

    <script type="module">
        import { events } from './events.js';

        let meta = JSON.parse(localStorage.getItem('god_sim_v6')) || {
            isotopes: 0,
            levels: { fishing: 0, mining: 0, agri: 0, growth: 0, max_year: 0 },
            addons: [], // Purchased addons
            addonCount: 0
        };

        const ADDONS = [
            { id: 'auto_smite', name: 'Auto-Smite', desc: 'Smites rivals automatically.' },
            { id: 'faith_bank', name: 'Faith Bank', desc: 'Faith carries over between runs.' },
            { id: 'deep_scan', name: 'Deep Scan', desc: 'Double isotopes found in events.' }
        ];

        let state = { active: false, year: 0, maxYear: 30, pop: 10, faith: 20, chunk: 0, chunks: Array.from({length:5},()=>Array(9).fill(0)), stabActive: false };

        window.renderTree = () => {
            document.getElementById('meta-isotopes').innerText = meta.isotopes + " ⚛";
            
            // Render Skill Tree (Similar to before...)
            const cats = ['survival', 'expansion', 'celestial'];
            const skillData = [
                {id:'fishing', cat:'survival', name:'Fishing', base:5},
                {id:'mining', cat:'survival', name:'Mining', base:8},
                {id:'agri', cat:'survival', name:'Agriculture', base:12}
            ];
            
            cats.forEach(c => {
                const el = document.getElementById(`tree-${c}`);
                if(!el) return;
                el.innerHTML = `<div class="category-title">${c.toUpperCase()}</div>`;
                skillData.filter(s => s.cat === c).forEach(s => {
                    const lv = meta.levels[s.id] || 0;
                    const cost = s.base * (lv + 1);
                    el.innerHTML += `<div class="addon-card">
                        <span>${s.name} (Lv ${lv})</span>
                        <button class="buy-btn" ${meta.isotopes<cost?'disabled':''} onclick="window.buySkill('${s.id}',${cost})">${cost} ⚛</button>
                    </div>`;
                });
            });

            // Render Addon Marketplace
            const addonEl = document.getElementById('addon-list');
            const addonCost = 100 * Math.pow(10, meta.addonCount);
            addonEl.innerHTML = `<p>Next Addon Cost: <b style="color:var(--gold)">${addonCost.toLocaleString()} ⚛</b></p>`;
            
            ADDONS.forEach(a => {
                const owned = meta.addons.includes(a.id);
                addonEl.innerHTML += `
                    <div class="addon-card ${owned ? '' : 'addon-locked'}">
                        <div><b>${a.name}</b><br><small>${a.desc}</small></div>
                        <button class="buy-btn" ${owned || meta.isotopes < addonCost ? 'disabled' : ''} onclick="window.buyAddon('${a.id}', ${addonCost})">
                            ${owned ? 'OWNED' : 'BUY'}
                        </button>
                    </div>`;
            });
        };

        window.buySkill = (id, cost) => { if(meta.isotopes >= cost) { meta.isotopes -= cost; meta.levels[id]++; save(); window.renderTree(); }};
        
        window.buyAddon = (id, cost) => {
            if(meta.isotopes >= cost) {
                meta.isotopes -= cost;
                meta.addons.push(id);
                meta.addonCount++;
                save();
                window.renderTree();
            }
        };

        window.startGame = () => {
            state.active = true; state.year = 0;
            state.maxYear = 30 + (meta.levels.max_year * 10);
            state.chunks = Array.from({length:5},()=>Array(9).fill(0));
            state.chunks[0][4] = 1;
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            gameTick();
        };

        function gameTick() {
            if(!state.active) return;
            state.year++;
            
            // Addon Feature: Auto Smite
            if(meta.addons.includes('auto_smite') && state.year % 5 === 0) window.smite();

            let growth = 0.02 + (meta.levels.fishing * 0.08) + (meta.levels.mining * 0.08) + (meta.levels.agri * 0.15);
            if(Math.random() < growth) expand(1);
            if(Math.random() < 0.12) expand(2);
            if(Math.random() < 0.15) triggerEvent();

            updateUI(); renderGrid();
            if(state.year >= state.maxYear) endGame();
            else setTimeout(gameTick, 1000);
        }

        function triggerEvent() {
            const ev = events[Math.floor(Math.random()*events.length)];
            if(ev.danger) startMinigame(ev);
            else applyEvent(ev);
        }

        function startMinigame(ev) {
            state.stabActive = true;
            let time = 3.0;
            const ui = document.getElementById('stabilize-ui');
            ui.classList.remove('hidden');
            
            const timer = setInterval(() => {
                time -= 0.1;
                document.getElementById('stab-timer').innerText = time.toFixed(1) + "s";
                if(!state.stabActive) { clearInterval(timer); ui.classList.add('hidden'); }
                if(time <= 0) { 
                    clearInterval(timer); ui.classList.add('hidden'); 
                    applyEvent(ev); // Fail: apply damage
                }
            }, 100);
        }

        window.stabilize = () => { 
            state.stabActive = false; 
            const log = document.getElementById('event-log');
            log.innerHTML = `<div style="color:var(--accent)">CORE STABILIZED!</div>` + log.innerHTML;
        };

        function applyEvent(ev) {
            if(ev.impact.pop) state.pop += ev.impact.pop;
            if(ev.impact.isotopes) { 
                let gain = ev.impact.isotopes;
                if(meta.addons.includes('deep_scan')) gain *= 2;
                meta.isotopes += gain; save(); 
            }
            const log = document.getElementById('event-log');
            log.innerHTML = `<div class="msg" style="${ev.style}">${ev.text}</div>` + log.innerHTML;
        }

        function expand(type) {
            const empties = state.chunks[state.chunk].map((t,i)=>t===0?i:-1).filter(i=>i!==-1);
            if(empties.length) state.chunks[state.chunk][empties[0]] = type;
        }

        window.smite = () => { state.chunks[state.chunk] = state.chunks[state.chunk].map(t => t===2?0:t); renderGrid(); };
        function renderGrid() {
            const c = document.getElementById('grid-container'); c.innerHTML = '';
            state.chunks[state.chunk].forEach(t => c.innerHTML += `<div class="tile ${t===1?'player':(t===2?'rival':'empty')}"></div>`);
        }
        function updateUI() { 
            document.getElementById('ui-year').innerText = (state.maxYear - state.year) + "Y";
            document.getElementById('ui-pop').innerText = "Pop: " + Math.floor(state.pop);
        }
        function save() { localStorage.setItem('god_sim_v6', JSON.stringify(meta)); }
        function endGame() { state.active = false; alert("Cycle End"); location.reload(); }

        window.renderTree();
    </script>
</body>
    </html>
